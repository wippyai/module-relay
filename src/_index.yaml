version: "1.0"
namespace: wippy.relay

entries:
  # Requirements
  - name: application_host
    kind: ns.requirement
    meta:
      description: "Host ID for the application processes"
    targets:
      - entry: wippy.relay.env:host
        path: ".default"
      - entry: central.service
        path: ".host"
      - entry: central.service
        path: ".lifecycle.depends_on +="
      - entry: user
        path: ".meta.default_host"

  - name: env_storage
    kind: ns.requirement
    meta:
      description: "Environment variable storage location"
    targets:
      - entry: wippy.relay.env:host
        path: ".storage"
      - entry: wippy.relay.env:max_connections_per_user
        path: ".storage"
      - entry: wippy.relay.env:queue_multiplier
        path: ".storage"
      - entry: wippy.relay.env:user_hub_inactivity_timeout
        path: ".storage"
      - entry: wippy.relay.env:user_security_scope
        path: ".storage"

  - name: user_security_scope
    kind: ns.requirement
    meta:
      description: "Environment variable storage location"
    targets:
      - entry: wippy.relay.env:user_security_scope
        path: ".default"

  - name: max_connections_per_user
    kind: ns.requirement
    meta:
      description: "Maximum WebSocket connections allowed per user"
    targets:
      - entry: wippy.relay.env:max_connections_per_user
        path: ".default"
    default: "5"

  - name: queue_multiplier
    kind: ns.requirement
    meta:
      description: "Message queue size multiplier (queue = connections Ã— multiplier)"
    targets:
      - entry: wippy.relay.env:queue_multiplier
        path: ".default"
    default: "100"

  - name: user_hub_inactivity_timeout
    kind: ns.requirement
    meta:
      description: "How long user hubs stay alive with no clients"
    targets:
      - entry: wippy.relay.env:user_hub_inactivity_timeout
        path: ".default"
    default: 300s

  # Dependencies
  - name: __dependency.wippy.actor
    kind: "ns.dependency"
    meta:
      description: "Actor component"
    component: "wippy/actor"
    version: ">=v0.2.0"

  # wippy.relay:central
  - name: central
    kind: process.lua
    meta:
      comment: Central hub that manages user-specific relay hubs
      depends_on:
        - ns:wippy.relay.env
        - ns:wippy.relay.security
    source: file://central.lua
    modules:
      - time
      - json
      - security
      - logger
    imports:
      actor: wippy.actor:actor
      consts: wippy.relay:consts
      plugin_discovery: wippy.relay.discovery:plugins
    method: run

  # wippy.relay:central.service
  - name: central.service
    kind: process.service
    meta:
      comment: Central relay hub service
    lifecycle:
      depends_on: []
      auto_start: true
      security:
        actor:
          id: relay.central
        groups:
          - wippy.relay.security:root
    process: wippy.relay:central

  # wippy.relay:consts
  - name: consts
    kind: library.lua
    meta:
      comment: Configuration constants and utilities
    source: file://consts.lua
    modules:
      - env
      - time

  # wippy.relay:user
  - name: user
    kind: process.lua
    meta:
      comment: User-specific hub for WebSocket connections and plugins
      depends_on:
        - ns:wippy.relay.env
        - ns:wippy.relay.security
    source: file://user.lua
    modules:
      - time
      - json
      - uuid
      - logger
    imports:
      actor: wippy.actor:actor
      consts: wippy.relay:consts
    method: run
